From bfce82e210621075e12665b8ababe5d24b441995 Mon Sep 17 00:00:00 2001
From: Bram Oosterhuis <dev@bybram.com>
Date: Tue, 9 Apr 2024 01:06:29 +0200
Subject: [PATCH] gst1-plugins-base: Add EGL and GMB support for OpenGL plugins

Signed-off-by: Bram Oosterhuis <dev@bybram.com>
---
 .../gstreamer1/gst1-plugins-base/Config.in    | 31 +++++++++++++++++++
 .../gst1-plugins-base/gst1-plugins-base.mk    | 10 ++++++
 2 files changed, 41 insertions(+)

diff --git a/package/gstreamer1/gst1-plugins-base/Config.in b/package/gstreamer1/gst1-plugins-base/Config.in
index df10774ac7..5da6fb7c9b 100644
--- a/package/gstreamer1/gst1-plugins-base/Config.in
+++ b/package/gstreamer1/gst1-plugins-base/Config.in
@@ -252,6 +252,37 @@ config BR2_PACKAGE_GST1_PLUGINS_BASE_LIB_OPENGL_DISPMANX
 comment "dispmanx needs the egl platform and rpi-userland"
 	depends on !BR2_PACKAGE_GST1_PLUGINS_BASE_LIB_OPENGL_EGL || \
 		!BR2_PACKAGE_RPI_USERLAND
+
+config BR2_PACKAGE_GST1_PLUGINS_BASE_LIB_OPENGL_LIBGBM
+	bool "libgbm"
+	default y
+	depends on BR2_PACKAGE_GST1_PLUGINS_BASE_LIB_OPENGL_EGL
+	depends on BR2_PACKAGE_HAS_LIBGBM
+	depends on !BR2_PACKAGE_WAYLAND
+	depends on !BR2_PACKAGE_XORG7
+	select BR2_PACKAGE_GST1_PLUGINS_BASE_LIB_OPENGL_HAS_WINDOW
+	select BR2_PACKAGE_LIBGUDEV
+	help
+	  Libdrm windowing system
+
+comment "libgbm needs the egl platform and libgbm"
+	depends on !BR2_PACKAGE_GST1_PLUGINS_BASE_LIB_OPENGL_EGL || \
+		!BR2_PACKAGE_HAS_LIBGBM || BR2_PACKAGE_WAYLAND || BR2_PACKAGE_XORG7
+
+config BR2_PACKAGE_GST1_PLUGINS_BASE_LIB_OPENGL_LIBEGL
+	bool "EGL"
+	default y
+	depends on BR2_PACKAGE_GST1_PLUGINS_BASE_LIB_OPENGL_EGL
+	depends on !BR2_PACKAGE_WAYLAND
+	depends on !BR2_PACKAGE_XORG7
+	select BR2_PACKAGE_GST1_PLUGINS_BASE_LIB_OPENGL_HAS_WINDOW
+	help
+	  EGL windowing system
+
+comment "EGL needs the egl platform"
+	depends on (!BR2_PACKAGE_GST1_PLUGINS_BASE_LIB_OPENGL_EGL || \
+		!BR2_PACKAGE_HAS_LIBGBM || BR2_PACKAGE_WAYLAND || BR2_PACKAGE_XORG7)
+
 endif
 
 comment "opengl needs an OpenGL or OpenGL ES backend"
diff --git a/package/gstreamer1/gst1-plugins-base/gst1-plugins-base.mk b/package/gstreamer1/gst1-plugins-base/gst1-plugins-base.mk
index 512e3fdee2..c3ed1cdde7 100644
--- a/package/gstreamer1/gst1-plugins-base/gst1-plugins-base.mk
+++ b/package/gstreamer1/gst1-plugins-base/gst1-plugins-base.mk
@@ -97,6 +97,16 @@ ifeq ($(BR2_PACKAGE_GST1_PLUGINS_BASE_LIB_OPENGL_DISPMANX),y)
 GST1_PLUGINS_BASE_WINSYS_LIST += dispmanx
 GST1_PLUGINS_BASE_DEPENDENCIES += rpi-userland
 endif
+
+ifeq ($(BR2_PACKAGE_GST1_PLUGINS_BASE_LIB_OPENGL_LIBGBM),y)
+GST1_PLUGINS_BASE_WINSYS_LIST += gbm
+GST1_PLUGINS_BASE_DEPENDENCIES += libgbm libgudev
+endif
+
+ifeq ($(BR2_PACKAGE_GST1_PLUGINS_BASE_LIB_OPENGL_LIBEGL),y)
+GST1_PLUGINS_BASE_WINSYS_LIST += egl
+endif
+
 GST1_PLUGINS_BASE_CONF_OPTS += -Dgl_winsys='$(subst $(space),$(comma),$(GST1_PLUGINS_BASE_WINSYS_LIST))'
 
 ifeq ($(BR2_PACKAGE_GST1_PLUGINS_BASE_PLUGIN_ADDER),y)
-- 
2.34.1

